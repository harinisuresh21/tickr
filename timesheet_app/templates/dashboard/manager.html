{% extends "base.html" %}
{% block title %}Manager Dashboard | TimesheetApp{% endblock %}

{% block sidebar %}
  {% include 'dashboard/manager_sidebar.html' %}
{% endblock %}
{% block body_extra %}
<script>
document.addEventListener('DOMContentLoaded', function(){
  const startForm = document.getElementById('manager-inline-timer-form');
  const stopBtn = document.getElementById('managerStopBtn');
  startForm.addEventListener('submit', function(e){
    e.preventDefault();
    const data = new FormData(startForm);
    fetch(startForm.action, {method:'POST', body:data, headers:{'x-requested-with':'XMLHttpRequest'}})
      .then(r=>r.json()).then(js=>{
        if (js.start_ms) startLiveTimer(js.start_ms);
      }).catch(err=>{ console.error(err); startForm.submit(); });
  });

  stopBtn.addEventListener('click', function(){
    // find running entry stop form in page (if rendered) else call stop endpoint generically
    // fallback: reload page
    fetch('{% url "manager_stop_time_entry" 0 %}'.replace('/0/', '/'), {method:'POST'}).catch(()=>location.reload());
  });
});
</script>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">

  <!-- Manager top area: reuse employee welcome + week UI + live timer + git graph -->
  <div class="topbar mb-3">
    <div>
      <h2 style="margin:0">Welcome back, {{ user.first_name|default:user.username }}</h2>
      <div class="small text-muted">Here's your activity and quick actions</div>
    </div>
    <div class="d-flex gap-3 align-items-center">
      <div class="card-modern text-center" style="min-width:140px" id="this-week-card">
        <div class="small text-muted">This week</div>
        <div id="this-week-hours" style="font-size:1.4rem; font-weight:700">{{ this_week_hours|default:0 }}h</div>
      </div>
      <div class="card-modern text-center" style="min-width:140px" id="approved-card">
        <div class="small text-muted">Approved</div>
        <div id="approved-count" style="font-size:1.4rem; font-weight:700">{{ approved_this_week|default:0 }}</div>
      </div>
      <div class="card-modern text-center" style="padding:10px; display:flex; gap:8px; align-items:center;">
        <div id="weekly-circles" style="display:flex; gap:6px;">
          {% for pair in week_day_pairs %}
            {% if pair.date == today %}
              <div class="week-day-circle today" title="{{ pair.date }}" style="width:36px;height:36px;border-radius:999px;display:flex;align-items:center;justify-content:center;background:#0d6efd;color:white;">
                <div style="font-weight:700">{{ pair.label }}</div>
              </div>
            {% else %}
              <div class="week-day-circle" title="{{ pair.date }}" style="width:36px;height:36px;border-radius:999px;display:flex;align-items:center;justify-content:center;border:1px solid #e9ecef;">
                <div style="font-weight:600">{{ pair.label }}</div>
              </div>
            {% endif %}
          {% endfor %}
        </div>
      </div>
    </div>
  </div>

    <div class="card-modern mb-4 start-timer-card">
    <div id="manager-running-timer">
      {% include 'dashboard/_running_timer.html' with start_name='manager_start_time_entry' stop_name='manager_stop_time_entry' container_id='manager-running-timer' %}
    </div>
  </div>


  <!-- Row: Employees & Projects -->
  <div class="row g-4 mb-4">
    <!-- Employees -->
    <div class="col-md-6">
      <div class="card shadow-sm">
        <div class="card-header fw-semibold">Employees</div>
        <div class="list-group list-group-flush">
          {% for emp in employees %}
            <div class="list-group-item d-flex justify-content-between align-items-center">
              <div>
                <div style="font-weight:600">{{ emp.get_full_name|default:emp.username }}</div>
                <small class="text-muted">{{ emp.email }}</small>
              </div>
              <a href="{% url 'approvals_list' %}?user={{ emp.id }}" 
                 class="btn btn-sm btn-outline-primary">View</a>
            </div>
          {% empty %}
            <div class="list-group-item text-muted">No employees found.</div>
          {% endfor %}
        </div>
      </div>
    </div>

    <!-- Projects -->
    <div class="col-md-6">
      <div class="card shadow-sm">
        <div class="card-header fw-semibold">Projects</div>
        <div class="list-group list-group-flush">
          {% for p in projects %}
            <div class="list-group-item d-flex justify-content-between align-items-center">
              <div>
                <div style="font-weight:600">{{ p.name }}</div>
                <small class="text-muted">{{ p.code }}</small>
              </div>
              <a href="{% url 'project_edit' p.id %}" 
                 class="btn btn-sm btn-outline-secondary">Edit</a>
            </div>
          {% empty %}
            <div class="list-group-item text-muted">No projects found.</div>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>

  <!-- Row: Pending Approvals -->
  <div class="card shadow-sm">
    <div class="card-header fw-semibold">Pending Approvals</div>
    <div class="table-responsive">
      <table class="table table-hover mb-0 align-middle">
        <thead class="table-light">
          <tr>
            <th>Employee</th>
            <th>Week Start</th>
            <th>Status</th>
            <th class="text-center">Actions</th>
          </tr>
        </thead>
        <tbody>
        {% for w in pending_weeks %}
          <tr>
            <td>{{ w.user.get_full_name|default:w.user.username }}</td>
            <td>{{ w.week_start|date:"M. d, Y" }}</td>
            <td><span class="badge bg-warning text-dark">{{ w.status|title }}</span></td>
            <td class="text-center">
              <form method="post" action="{% url 'week_detail' w.id %}" style="display:inline">
                {% csrf_token %}
                <button type="submit" name="action" value="approve" class="btn btn-sm btn-success">Approve</button>
              </form>
              <form method="post" action="{% url 'week_detail' w.id %}" style="display:inline; margin-left:6px">
                {% csrf_token %}
                <button type="submit" name="action" value="reject" class="btn btn-sm btn-danger">Reject</button>
              </form>
              <a href="{% url 'week_detail' w.id %}" class="btn btn-sm btn-outline-primary" style="margin-left:6px">View</a>
            </td>
          </tr>
        {% empty %}
          <tr>
            <td colspan="4" class="text-center text-muted py-4">No submissions waiting.</td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

</div>
{% endblock %}

{% block extra_scripts %}
  {% include 'dashboard/_live_timer_init.html' %}
{% endblock %}
